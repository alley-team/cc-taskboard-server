# API

## 1. Настройка базы данных

Настройка базы данных в целом проводится единожды, создавая в PostgreSQL четыре таблицы. Но метод может создавать только те таблицы, которые отсутствуют в базе данных, и если вы удалили несколько, вызов этого метода повлечёт создание этих таблиц.

Метод и адрес: `GET /pg-setup`

Для работы метода необходимо передать заголовок `App-Token`, содержащий закодированный в base64 JSON:

```json
{
  "key": "<Ключ администратора>"
}
```

Метод возвращает код 200 в случае успеха и может возвращать коды 401, 500 в случае ошибки. Текст ошибки передаётся в теле.

## 2. Регистрация пользователя

Регистрация пользователя необходима для работы в приложении CC TaskBoard. Аккаунт даёт возможность получать доступ к доскам и создавать свои.

Метод и адрес: `PUT /sign-up`

Для работы метода необходимо передать заголовок `App-Token`, содержащий закодированный в base64 JSON:

```json
{
  "login": "<Логин>",
  "pass": "<Пароль длиной не менее 8 символов>",
  "cc_key": "<Ключ регистрации>"
}
```

В случае успеха метод возвращает код 200 и передаёт в теле ответа токен, который необходимо передавать каждый раз в заголовке `App-Token` для аутентификации действий пользователя:

```json
{
  "id": 1234567890,
  "token": "<Токен>"
}
```

Токен валиден в течение 5 дней, которые не использовался.

Помимо этого, метод может возвращать коды 400, 401, 500 в случае ошибки. Текст ошибки передаётся в теле.

## 3. Вход пользователя в аккаунт и получение токена

Вход в аккаунт необходим для получения пользователем токена. Он используется для аутентификации вместо логина и пароля.

Метод и адрес: `GET /sign-in`

Для работы метода необходимо передать заголовок `App-Token`, содержащий закодированный в base64 JSON:

```json
{
  "login": "<Логин>",
  "pass": "<Пароль>",
}
```

В случае успеха метод возвращает код 200 и передаёт в теле ответа токен, который необходимо передавать каждый раз в заголовке `App-Token` для аутентификации действий пользователя:

```json
{
  "id": 1234567890,
  "token": "<Токен>"
}
```

Токен валиден в течение 5 дней, которые не использовался.

Помимо этого, метод может возвращать коды 401, 500 в случае ошибки. Текст ошибки передаётся в теле.

## 4. Создание доски

Доска - главный объект в CC TaskBoard. Она содержит карточки с задачами и подзадачами и может быть доступна тем пользователям, с которым ею поделились. Пользователи не имеют права редактировать доску, в отличие от содержимого внутри, которое было также создано ими.

Метод и адрес: `PUT /board`

Для работы метода необходимо передать токен в заголовке `App-Token`, а в теле запроса - закодированный в base64 JSON вида:

```json
{
  "id": 0,
  "author": 0,
  "shared_with": [],
  "title": "<Заголовок доски>",
  "cards": [],
  "background_color": "#<Цвет RRGGBB>"
}
```

Передача различных значений в полях id и author не имеет смысла, так как сервер игнорирует их. Например, владелец токена становится владельцем доски, и его id из токена записывается в поле author. Идентификатор доски генерируется базой данных.

Передача одного или нескольких id в списке shared_with и карточек в cards также смысла не имеет.

В случае успеха метод возвращает код 200 и передаёт в теле ответа идентификатор доски. Помимо этого, метод может возвращать коды 400, 401, 402, 500 в случае ошибки. Текст ошибки передаётся в теле.

## 5. Получение доски

Всё содержимое доски можно получить за один раз. Это требуется для отрисовки доски в приложении.

Метод и адрес: `GET /board`

Для работы метода необходимо передать токен в заголовке `App-Token`, а в теле запроса - закодированный в base64 JSON вида:

```json
{
  "board_id": 1234567890,
}
```

В случае успеха метод возвращает код 200 и передаёт в теле ответа JSON:

```json
{
  "id": 1234567890,
  "author": 1234567890,
  "shared_with": [1, 2, 3,],
  "title": "<Заголовок доски>",
  "cards": [{}, {}, {},],
  "background_color": "#<Цвет RRGGBB>"
}
```

Помимо этого, метод может возвращать коды 400, 401, 500 в случае ошибки. Текст ошибки передаётся в теле.

## 6. Изменение доски

У каждой доски можно менять её заголовок и цвет фона.

Метод и адрес: `PATCH /board`

Для работы метода необходимо передать токен в заголовке `App-Token`, а в теле запроса - закодированный в base64 JSON вида:

```json
{
  "board_id": 1234567890,
  "title": "<Заголовок доски>",
  "background_color": "#<Цвет RRGGBB>"
}
```

В JSON также можно передавать только title или только background_color вместо отправки двух сразу.

Метод возвращает код 200 в случае успеха и может возвращать коды 400, 401, 500 в случае ошибки. Текст ошибки передаётся в теле.

## 7. Удаление доски

Удаление доски происходит в два этапа: сначала её идентификатор удаляется из shared_boards всех ассоциированных пользователей, а затем - уже из таблицы boards.

Метод и адрес: `DELETE /board`

Для работы метода необходимо передать токен в заголовке `App-Token`, а в теле запроса - закодированный в base64 JSON вида:

```json
{
  "board_id": 1234567890,
}
```

Метод возвращает код 200 в случае успеха и может возвращать коды 400, 401, 500 в случае ошибки. Текст ошибки передаётся в теле.

## 8. Создание ключа регистрации

Метод требуется для регистрации новых пользователей.

Метод и адрес: `GET /cc-key`

Для работы метода необходимо передать заголовок `App-Token`, содержащий закодированный в base64 JSON:

```json
{
  "key": "<Ключ администратора>"
}
```

Метод возвращает код 200 в случае успеха и передаёт в теле ответа ключ регистрации. Помимо этого, метод может возвращать коды 401, 500 в случае ошибки. Текст ошибки передаётся в теле.

## 9. Создание карточек

Карточки отделяют типы задач внутри одной доски.

Метод и адрес: `PUT /card`

Для работы метода необходимо передать токен в заголовке `App-Token`, а в теле запроса - закодированный в base64 JSON вида:

```json
{
  "board_id": 1234567890,
  "card": {
    "id": 1234567890,
    "author": 1234567890,
    "title": "<Заголовок карточки>",
    "tasks": [{},{},{},],
    "color_set": {
      "text_color": "#xxxxxx",
      "background_color": "#xxxxxx",
    },
  }
}
```

В поле `card->tasks` можно передавать валидные вложенные структуры задач.

Чтобы избежать коллизии нескольких id, все идентификаторы - карточки, вложенных задач и подзадач - будут переназначены. При этом метод возвращает только идентификатор карточки. Авторство всех вложенных сущностей также будет за пользователем, вызвавшим метод.

Метод возвращает код 200 в случае успеха и передаёт в теле ответа идентификатор карточки. Помимо этого, метод может возвращать коды 400, 401, 500 в случае ошибки. Текст ошибки передаётся в теле.

## 10. Изменение карточки

В карточках можно менять заголовок, цвет текста и цвет фона.

Метод и адрес: `PATCH /card`

Для работы метода необходимо передать токен в заголовке `App-Token`, а в теле запроса - закодированный в base64 JSON вида:

```json
{
  "board_id": 1234567890,
  "card_id": 1234567890,
  "title": "<Заголовок карточки>",
  "text_color": "#xxxxxx",
  "background_color": "#xxxxxx"
}
```

Поля `title`, `text_color` и `background_color` опциональные.

Метод возвращает код 200 в случае успеха и может возвращать коды 400, 401, 500 в случае ошибки. Текст ошибки передаётся в теле.

## 11. Удаление карточки

Вместе с карточкой удаляются её задачи и подзадачи.

Метод и адрес: `DELETE /card`

Для работы метода необходимо передать токен в заголовке `App-Token`, а в теле запроса - закодированный в base64 JSON вида:

```json
{
  "board_id": 1234567890,
  "card_id": 1234567890
}
```

Метод возвращает код 200 в случае успеха и может возвращать коды 400, 401, 500 в случае ошибки. Текст ошибки передаётся в теле.

## 12. Создание задач

Метод и адрес: `PUT /task`

Для работы метода необходимо передать токен в заголовке `App-Token`, а в теле запроса - закодированный в base64 JSON вида:

```json
{
  "board_id": 1234567890,
  "card_id": 1234567890,
  "task": {
    "id": 1234567890,
    "author": 1234567890,
    "title": "<Заголовок карточки>",
    "executors": [],
    "exec": true/false,
    "subtasks": [{},{},{},],
    "notes": "<Заметки>",
    "tags": [{},{},{},],
    "timelines": {},
    "color_set": {
      "text_color": "#xxxxxx",
      "background_color": "#xxxxxx",
    },
  }
}
```

В поле `task->subtasks` можно передавать валидные вложенные структуры подзадач.

Чтобы избежать коллизии нескольких id, все идентификаторы - задачи и вложенных подзадач - будут переназначены. При этом метод возвращает только идентификатор задачи. Авторство всех вложенных сущностей также будет за пользователем, вызвавшим метод. Исполнители задачи и подзадач будут назначены только при условии, что исполнителю доступна доска.

Метод возвращает код 200 в случае успеха и передаёт в теле ответа идентификатор задачи. Помимо этого, метод может возвращать коды 400, 401, 500 в случае ошибки. Текст ошибки передаётся в теле.

### 12.1. Теги `tags`

В задачах впервые появляются теги:

```json
[
  {
    "title": "<Метка>",
    "color_set": {
      "text_color": "#xxxxxx",
      "background_color": "#xxxxxx",
    }
  },..
]
```

Набор таких тегов есть и у подзадач. Редактировать набор тегов можно при помощи методов `/task/tags` и `/subtask/tags`.

### 12.2. Временные рамки `timelines`

В задачах впервые появляются ещё и временные рамки:

```json
{
  "preferred_time": 1234567890,
  "max_time": 1234567890,
  "expected_time": 1234567890
}
```

Первые два параметра представляют из себя количество секунд с эпохи Unix (00:00 1 января 1970 года). Параметр `expected_time` хранит количество минут, примерно требующихся для выполнения задачи.

Свои временные рамки есть у задач и подзадач. Редактировать временные рамки можно при помощи методов `/task/time` и `/subtask/time`.

## 13. Изменение задачи

Метод и адрес: `PATCH /task`

Для работы метода необходимо передать токен в заголовке `App-Token`, а в теле запроса - закодированный в base64 JSON вида:

```json
{
  "board_id": 1234567890,
  "card_id": 1234567890,
  "task_id": 1234567890,
  "title": "<Заголовок карточки>",
  "executors": [],
  "exec": true/false,
  "notes": "<Заметки>",
  "text_color": "#xxxxxx",
  "background_color": "#xxxxxx"
}
```

Исполнители задачи будут назначены только при условии, что исполнителю доступна данная доска.

Метод возвращает код 200 в случае успеха и может возвращать коды 400, 401, 500 в случае ошибки. Текст ошибки передаётся в теле.
