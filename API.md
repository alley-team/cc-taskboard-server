# API

## Оглавление

1. [Настройка базы данных](#1)
1. [Создание ключа регистрации](#2)
1. [Регистрация пользователя](#3)
1. [Вход пользователя в аккаунт и получение токена](#4)
1. [Получение списка досок пользователя](#5)
1. [Создание доски](#6)
1. [Получение доски](#7)
1. [Изменение доски](#8)
1. [Удаление доски](#9)
1. [Создание карточки](#10)
1. [Изменение карточки](#11)
1. [Удаление карточки](#12)
1. [Создание задачи](#13)
1. [Метки](#14)
1. [Временные рамки](#15)
1. [Изменение задачи](#16)
1. [Удаление задачи](#17)
1. [Редактирование меток задачи](#18)
1. [Редактирование временных рамок задачи](#19)
1. [Создание подзадачи](#20)
1. [Изменение подзадачи](#21)
1. [Удаление подзадачи](#22)
1. [Редактирование меток подзадачи](#23)
1. [Редактирование временных рамок подзадачи](#24)

## Примечания

Работа с API выглядит следующим образом:

1. Администратор выпускает ключ регистрации и делится им с пользователем
1. Пользователь регистрируется и получает новый токен
1. Пользователь отправляет запросы с этим токеном

Сервер умеет манипулировать такими сущностями, как Board, Card, Task, Subtask, Tag, Timeline и другими (см. [model.rs](./src/model.rs) и [auth.rs](./src/sec/auth.rs)).

В некоторых методах, которые создают сущность из запроса клиента и возвращают клиенту идентификатор этой сущности в базе данных, можно передавать любой id в сущности, так как он, очевидно, будет переназначен. В методах же, которые редактируют сущности, большинство параметров являются необязательными для отправки, и, например, если мы хотим поменять в подзадаче только цвет фона, то параметры цвета текста, заголовок задачи, исполнителей и отметку о выполнении отправлять не нужно.

## <a name="1"></a> 1. Настройка базы данных

Настройка базы данных в целом проводится единожды, создавая в PostgreSQL четыре таблицы. Но метод может создавать только те таблицы, которые отсутствуют в базе данных, и если вы удалили несколько, вызов этого метода повлечёт создание этих таблиц.

Метод и адрес: `GET /pg-setup`

Для работы метода необходимо передать заголовок `App-Token`, содержащий закодированный в base64 JSON:

```json
{
  "key": "<Ключ администратора>"
}
```

Метод возвращает код 200 в случае успеха и может возвращать коды 401, 500 в случае ошибки. Текст ошибки передаётся в теле.

## <a name="2"></a> 2. Создание ключа регистрации

Метод требуется для регистрации новых пользователей.

Метод и адрес: `GET /cc-key`

Для работы метода необходимо передать заголовок `App-Token`, содержащий закодированный в base64 JSON:

```json
{
  "key": "<Ключ администратора>"
}
```

Метод возвращает код 200 в случае успеха и передаёт в теле ответа ключ регистрации. Помимо этого, метод может возвращать коды 401, 500 в случае ошибки. Текст ошибки передаётся в теле.

## <a name="3"></a> 3. Регистрация пользователя

Регистрация пользователя необходима для работы в приложении CC TaskBoard. Аккаунт даёт возможность получать доступ к доскам и создавать свои.

Метод и адрес: `PUT /sign-up`

Для работы метода необходимо передать заголовок `App-Token`, содержащий закодированный в base64 JSON:

```json
{
  "login": "<Логин>",
  "pass": "<Пароль длиной не менее 8 символов>",
  "cc_key": "<Ключ регистрации>"
}
```

В случае успеха метод возвращает код 200 и передаёт в теле ответа токен, который необходимо передавать каждый раз в заголовке `App-Token` для аутентификации действий пользователя:

```json
{
  "id": 1234567890,
  "token": "<Токен>"
}
```

Токен валиден в течение 5 дней, которые не использовался.

Помимо этого, метод может возвращать коды 400, 401, 500 в случае ошибки. Текст ошибки передаётся в теле.

## <a name="4"></a> 4. Вход пользователя в аккаунт и получение токена

Вход в аккаунт необходим для получения пользователем токена. Он используется для аутентификации вместо логина и пароля.

Метод и адрес: `GET /sign-in`

Для работы метода необходимо передать заголовок `App-Token`, содержащий закодированный в base64 JSON:

```json
{
  "login": "<Логин>",
  "pass": "<Пароль>",
}
```

В случае успеха метод возвращает код 200 и передаёт в теле ответа токен, который, **предварительно закодировав в base64,** необходимо будет передавать каждый раз в заголовке `App-Token` для аутентификации действий пользователя:

```json
{
  "id": 1234567890,
  "token": "<Токен>"
}
```

Токен валиден в течение 5 дней, которые не использовался.

Помимо этого, метод может возвращать коды 401, 500 в случае ошибки. Текст ошибки передаётся в теле.

## <a name="5"></a> 5. Получение списка досок, доступных пользователю

Метод и адрес: `GET /list`

Для работы метода необходимо передать токен в заголовке `App-Token`.

Метод возвращает статус 200 и JSON-массив с данными о доске (`id`, `title`, `header_background_color` и `header_text_color`), либо ошибки 401 и 500.

## <a name="6"></a> 6. Создание доски

Доска - главный объект в CC TaskBoard. Она содержит карточки с задачами и подзадачами и может быть доступна тем пользователям, с которым ею поделились. Пользователи не имеют права редактировать доску, в отличие от содержимого внутри, которое было также создано ими.

Метод и адрес: `PUT /board`

Для работы метода необходимо передать токен в заголовке `App-Token`, а в теле запроса - закодированный в base64 JSON вида:

```json
{
  "id": 0,
  "author": 0,
  "shared_with": [],
  "header": {
    "title": "<Заголовок доски>",
    "header_background_color": "#<Цвет RRGGBB>",
    "header_text_color": "#<Цвет RRGGBB>",
  },
  "cards": [],
  "background_color": "#<Цвет RRGGBB>"
}
```

Передача различных значений в полях id и author не имеет смысла, так как сервер игнорирует их. Например, владелец токена становится владельцем доски, и его id из токена записывается в поле author. Идентификатор доски генерируется базой данных.

Передача одного или нескольких id в списке shared_with и карточек в cards также смысла не имеет.

В случае успеха метод возвращает код 200 и передаёт в теле ответа идентификатор доски. Помимо этого, метод может возвращать коды 400, 401, 402, 500 в случае ошибки. Текст ошибки передаётся в теле.

## <a name="7"></a> 7. Получение доски

Всё содержимое доски можно получить за один раз. Это требуется для отрисовки доски в приложении.

Метод и адрес: `POST /board`

Для работы метода необходимо передать токен в заголовке `App-Token`, а в теле запроса - закодированный в base64 JSON вида:

```json
{
  "board_id": 1234567890,
}
```

В случае успеха метод возвращает код 200 и передаёт в теле ответа JSON:

```json
{
  "id": 1234567890,
  "author": 1234567890,
  "shared_with": [1, 2, 3,],
  "title": "<Заголовок доски>",
  "cards": [{}, {}, {},],
  "background_color": "#<Цвет RRGGBB>"
}
```

Помимо этого, метод может возвращать коды 400, 401, 500 в случае ошибки. Текст ошибки передаётся в теле.

## <a name="8"></a> 8. Изменение доски

У каждой доски можно менять её заголовок и цвет фона.

Метод и адрес: `PATCH /board`

Для работы метода необходимо передать токен в заголовке `App-Token`, а в теле запроса - закодированный в base64 JSON вида:

```json
{
  "board_id": 1234567890,
  "title": "<Заголовок доски>",
  "background_color": "#<Цвет RRGGBB>",
  "header_background_color": "#<Цвет RRGGBB>",
  "header_text_color": "#<Цвет RRGGBB>"
}
```

В JSON также можно передавать только title или только background_color вместо отправки всех сразу.

Метод возвращает код 200 в случае успеха и может возвращать коды 400, 401, 500 в случае ошибки. Текст ошибки передаётся в теле.

## <a name="9"></a> 9. Удаление доски

Удаление доски происходит в два этапа: сначала её идентификатор удаляется из shared_boards всех ассоциированных пользователей, а затем - уже из таблицы boards.

Метод и адрес: `DELETE /board`

Для работы метода необходимо передать токен в заголовке `App-Token`, а в теле запроса - закодированный в base64 JSON вида:

```json
{
  "board_id": 1234567890,
}
```

Метод возвращает код 200 в случае успеха и может возвращать коды 400, 401, 500 в случае ошибки. Текст ошибки передаётся в теле.

## <a name="10"></a> 10. Создание карточки

Карточки отделяют типы задач внутри одной доски.

Метод и адрес: `PUT /card`

Для работы метода необходимо передать токен в заголовке `App-Token`, а в теле запроса - закодированный в base64 JSON вида:

```json
{
  "board_id": 1234567890,
  "card": {
    "id": 1234567890,
    "author": 1234567890,
    "title": "<Заголовок карточки>",
    "tasks": [{},{},{},],
    "header_background_color": "#xxxxxx",
    "header_text_color": "#xxxxxx",
    "background_color": "#xxxxxx"
  }
}
```

В поле `card->tasks` можно передавать валидные вложенные структуры задач.

Чтобы избежать коллизии нескольких id, все идентификаторы - карточки, вложенных задач и подзадач - будут переназначены. При этом метод возвращает только идентификатор карточки. Авторство всех вложенных сущностей также будет за пользователем, вызвавшим метод.

Метод возвращает код 200 в случае успеха и передаёт в теле ответа идентификатор карточки. Помимо этого, метод может возвращать коды 400, 401, 500 в случае ошибки. Текст ошибки передаётся в теле.

## <a name="11"></a> 11. Изменение карточки

В карточках можно менять заголовок, цвет текста и цвет фона.

Метод и адрес: `PATCH /card`

Для работы метода необходимо передать токен в заголовке `App-Token`, а в теле запроса - закодированный в base64 JSON вида:

```json
{
  "board_id": 1234567890,
  "card_id": 1234567890,
  "title": "<Заголовок карточки>",
  "header_background_color": "#xxxxxx",
  "header_text_color": "#xxxxxx",
  "background_color": "#xxxxxx"
}
```

Поля `title`, `header_background_color`, `header_text_color` и `background_color` опциональные.

Метод возвращает код 200 в случае успеха и может возвращать коды 400, 401, 500 в случае ошибки. Текст ошибки передаётся в теле.

## <a name="12"></a> 12. Удаление карточки

Вместе с карточкой удаляются её задачи и подзадачи.

Метод и адрес: `DELETE /card`

Для работы метода необходимо передать токен в заголовке `App-Token`, а в теле запроса - закодированный в base64 JSON вида:

```json
{
  "board_id": 1234567890,
  "card_id": 1234567890
}
```

Метод возвращает код 200 в случае успеха и может возвращать коды 400, 401, 500 в случае ошибки. Текст ошибки передаётся в теле.

## <a name="13"></a> 13. Создание задачи

Метод и адрес: `PUT /task`

Для работы метода необходимо передать токен в заголовке `App-Token`, а в теле запроса - закодированный в base64 JSON вида:

```json
{
  "board_id": 1234567890,
  "card_id": 1234567890,
  "task": {
    "id": 1234567890,
    "author": 1234567890,
    "title": "<Задача>",
    "executors": [],
    "exec": false,
    "subtasks": [{},{},{},],
    "notes": "<Заметки>",
    "tags": [{...},{...},{...},],
    "timelines": {...}
  }
}
```

В поле `task->subtasks` можно передавать валидные вложенные структуры подзадач.

Чтобы избежать коллизии нескольких id, все идентификаторы - задачи и вложенных подзадач - будут переназначены. При этом метод возвращает только идентификатор задачи. Авторство всех вложенных сущностей также будет за пользователем, вызвавшим метод. Исполнители задачи и подзадач будут назначены только при условии, что исполнителю доступна доска.

Метод возвращает код 200 в случае успеха и передаёт в теле ответа идентификатор задачи. Помимо этого, метод может возвращать коды 400, 401, 500 в случае ошибки. Текст ошибки передаётся в теле.

### <a name="14"></a> 14. Метки `tags`

В задачах впервые появляются метки:

```json
[
  {
    "title": "<Метка>",
    "text_color": "#xxxxxx",
    "background_color": "#xxxxxx"
  },
]
```

Набор таких меток есть и у подзадач. Редактировать набор меток можно при помощи методов `/task/tags` и `/subtask/tags` (см. пункты [18](#18) и [23](#23)).

### <a name="15"></a> 15. Временные рамки `timelines`

В задачах впервые появляются ещё и временные рамки:

```json
{
  "preferred_time": 1234567890,
  "max_time": 1234567890,
  "expected_time": 1234567890
}
```

Первые два параметра представляют из себя количество секунд с эпохи Unix (00:00 1 января 1970 года). Параметр `expected_time` хранит количество минут, примерно требующихся для выполнения задачи.

Важно, что временные рамки передавать обязательно всегда. Если временные рамки не установлены пользователем, установите их в значение 0.

Свои временные рамки есть у задач и подзадач. Редактировать временные рамки можно при помощи методов `/task/time` и `/subtask/time` (см. пункты [19](#19) и [24](#24)).

## <a name="16"></a> 16. Изменение задачи

Метод и адрес: `PATCH /task`

Для работы метода необходимо передать токен в заголовке `App-Token`, а в теле запроса - закодированный в base64 JSON вида:

```json
{
  "board_id": 1234567890,
  "card_id": 1234567890,
  "task_id": 1234567890,
  "title": "<Задача>",
  "executors": [],
  "exec": false,
  "notes": "<Заметки>"
}
```

Исполнители задачи будут назначены только при условии, что исполнителю доступна данная доска.

Метод возвращает код 200 в случае успеха и может возвращать коды 400, 401, 500 в случае ошибки. Текст ошибки передаётся в теле.

## <a name="17"></a> 17. Удаление задачи

Метод и адрес: `DELETE /task`

Для работы метода необходимо передать токен в заголовке `App-Token`, а в теле запроса - закодированный в base64 JSON вида:

```json
{
  "board_id": 1234567890,
  "card_id": 1234567890,
  "task_id": 1234567890
}
```

Метод возвращает код 200 в случае успеха и может возвращать коды 400, 401, 500 в случае ошибки. Текст ошибки передаётся в теле.

## <a name="18"></a> 18. Редактирование меток задачи

Метод и адрес: `PATCH /task/tags`

Для работы метода необходимо передать токен в заголовке `App-Token`, а в теле запроса - закодированный в base64 JSON вида:

```json
{
  "board_id": 1234567890,
  "card_id": 1234567890,
  "task_id": 1234567890,
  "tags": [
    {
      "title": "<Метка>",
      "text_color": "#xxxxxx",
      "background_color": "#xxxxxx"
    },
  ]
}
```

Метод возвращает код 200 в случае успеха и может возвращать коды 400, 401, 500 в случае ошибки. Текст ошибки передаётся в теле.

## <a name="19"></a> 19. Редактирование временных рамок задачи

Метод и адрес: `PATCH /task/time`

Для работы метода необходимо передать токен в заголовке `App-Token`, а в теле запроса - закодированный в base64 JSON вида:

```json
{
  "board_id": 1234567890,
  "card_id": 1234567890,
  "task_id": 1234567890,
  "timelines": {
    "preferred_time": 1234567890,
    "max_time": 1234567890,
    "expected_time": 1234567890
  }
}
```

Метод возвращает код 200 в случае успеха и может возвращать коды 400, 401, 500 в случае ошибки. Текст ошибки передаётся в теле.

## <a name="20"></a> 20. Создание подзадачи

Метод и адрес: `PUT /subtask`

Для работы метода необходимо передать токен в заголовке `App-Token`, а в теле запроса - закодированный в base64 JSON вида:

```json
{
  "board_id": 1234567890,
  "card_id": 1234567890,
  "task_id": 1234567890,
  "subtask": {
    "id": 1234567890,
    "author": 1234567890,
    "title": "<Подзадача>",
    "executors": [],
    "exec": false,
    "tags": [{...},{...},{...},],
    "timelines": {...}
  }
}
```

Обратите внимание на содержимое значений "tags" и "timelines" (см. пункт [12.1](#12a) и [12.2](#12b)).

Исполнители подзадачи будут назначены только при условии, что исполнителю доступна доска.

Метод возвращает код 200 в случае успеха и передаёт в теле ответа идентификатор подзадачи. Помимо этого, метод может возвращать коды 400, 401, 500 в случае ошибки. Текст ошибки передаётся в теле.

## <a name="21"></a> 21. Изменение подзадачи

Метод и адрес: `PATCH /subtask`

Для работы метода необходимо передать токен в заголовке `App-Token`, а в теле запроса - закодированный в base64 JSON вида:

```json
{
  "board_id": 1234567890,
  "card_id": 1234567890,
  "task_id": 1234567890,
  "subtask_id": 1234567890,
  "title": "<Заголовок карточки>",
  "executors": [],
  "exec": false
}
```

Исполнители подзадачи будут назначены только при условии, что исполнителю доступна данная доска.

Метод возвращает код 200 в случае успеха и может возвращать коды 400, 401, 500 в случае ошибки. Текст ошибки передаётся в теле.

## <a name="22"></a> 22. Удаление подзадачи

Метод и адрес: `DELETE /subtask`

Для работы метода необходимо передать токен в заголовке `App-Token`, а в теле запроса - закодированный в base64 JSON вида:

```json
{
  "board_id": 1234567890,
  "card_id": 1234567890,
  "task_id": 1234567890,
  "subtask_id": 1234567890,
}
```

Метод возвращает код 200 в случае успеха и может возвращать коды 400, 401, 500 в случае ошибки. Текст ошибки передаётся в теле.

## <a name="23"></a> 23. Редактирование меток подзадачи

Метод и адрес: `PATCH /subtask/tags`

Для работы метода необходимо передать токен в заголовке `App-Token`, а в теле запроса - закодированный в base64 JSON вида:

```json
{
  "board_id": 1234567890,
  "card_id": 1234567890,
  "task_id": 1234567890,
  "subtask_id": 1234567890,
  "tags": [
    {
      "title": "<Метка>",
      "text_color": "#xxxxxx",
      "background_color": "#xxxxxx"
    },
  ]
}
```

Метод возвращает код 200 в случае успеха и может возвращать коды 400, 401, 500 в случае ошибки. Текст ошибки передаётся в теле.

## <a name="24"></a> 24. Редактирование временных рамок подзадачи

Метод и адрес: `PATCH /subtask/time`

Для работы метода необходимо передать токен в заголовке `App-Token`, а в теле запроса - закодированный в base64 JSON вида:

```json
{
  "board_id": 1234567890,
  "card_id": 1234567890,
  "task_id": 1234567890,
  "subtask_id": 1234567890,
  "timelines": {
    "preferred_time": 1234567890,
    "max_time": 1234567890,
    "expected_time": 1234567890
  }
}
```

Метод возвращает код 200 в случае успеха и может возвращать коды 400, 401, 500 в случае ошибки. Текст ошибки передаётся в теле.
